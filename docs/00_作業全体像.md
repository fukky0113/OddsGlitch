# Value Hunter — 作業全体像

## 1. 入力（インプット）の定義

**本システムの入力（インプット）は、次の1ファイルである。**

| 項目 | 内容 |
|------|------|
| **入力ファイル** | **`output/result.json`** |
| **形式** | JSON（UTF-8） |
| **役割** | レース1件分の競馬新聞相当データ。レース情報・出走馬一覧（オッズ・人気・過去5走含む）を格納する。 |
| **生成元** | OddsGlitch（`main.py`）が netkeiba から取得・出力したもの。 |

**それ以外の入力は一切用いない。**

---

## 2. 入力スキーマ（output/result.json の構造）

正式な仕様は **`output/result.json`** の実ファイルに準拠する。

### トップレベル

| キー | 型 | 説明 |
|------|-----|------|
| `source_url` | string | 取得元ページURL |
| `race_id` | string | レース識別子（12桁） |
| `race` | object | レース基本情報 |
| `race_info` | object | 拡張用（現状は空でも可） |
| `horses` | array | 出走馬の配列 |

### race オブジェクト

| キー | 型 | 例 |
|------|-----|-----|
| `race_name` | string | "3歳1勝クラス" |
| `post_time` | string | "12:50" |
| `course_type` | string | "ダ" |
| `distance` | number | 1400 |
| `track_condition` | string | "良" |
| `weather` | string | "曇" |
| `race_date` | string | "2026/02/07" |
| `venue` | string | "京都" |

### horses 配列の要素（1頭分）

| キー | 型 | 説明 |
|------|-----|------|
| `number` | number | 馬番 |
| `horse_id` | string | 馬ID |
| `horse_name` | string | 馬名 |
| `jockey` | string | 騎手名 |
| `weight` | number | 斤量 |
| `odds` | number/null | 単勝オッズ |
| `popularity` | number/null | 人気順位（1始まり） |
| `past_races` | array | 過去走配列（最大5走） |

### past_races の要素（1走分）

| キー | 型 | 説明 |
|------|-----|------|
| `run` | number | 何走前か（1=直近） |
| `date` | string | 日付 |
| `venue` | string | 開催場所 |
| `position` | number | 着順 |
| `time` | string | タイム |
| `last_3f` | string | 上がり3F |
| `popularity` | number | そのレースでの人気 |

---

## 3. 処理概要

`output/result.json` を入力に、以下の処理を行う。

```
入力: output/result.json
  │
  ├── 1. 読み込み・バリデーション
  │
  ├── 2. 各馬のスコア算出
  │     ├── Form Score  (40%) … 着順ベースのフォーム（直近重視の加重平均）
  │     ├── Last3F Score (25%) … 上がり3Fの速さ
  │     ├── Upset Score  (20%) … 人気以上に好走した実績
  │     └── Venue Score  (15%) … 今回と同コースでの好走実績
  │
  ├── 3. Ability Rank 算出（スコア降順で順位付け）
  │
  ├── 4. Gap 算出
  │     Gap = 人気順位 − 能力順位
  │     正 = 市場が過小評価（バリューあり）
  │     負 = 市場が過大評価
  │
  ├── 5. 評価ランク付与
  │     S: Gap ≥ 4 かつ スコア ≥ 平均
  │     A: Gap ≥ 2 かつ スコア ≥ 平均×0.8
  │     B: Gap ≥ 0
  │     C: Gap < 0
  │
  └── 6. 出力
        ├── コンソール: 評価テーブル + スコア内訳 + 注目馬サマリー
        └── JSON: output/value_hunter_result.json
```

---

## 4. スコア算出の詳細

### 4.1 Form Score（着順フォーム / 配分 40%）

過去走の着順をポイントに変換し、直近レースほど重みを高くした加重平均。

| 着順 | ポイント |
|------|----------|
| 1着 | 100 |
| 2着 | 85 |
| 3着 | 75 |
| 4着 | 65 |
| 5着 | 55 |
| 6着 | 45 |
| 7着 | 35 |
| 8着 | 25 |
| 9着 | 15 |
| 10着以下 | 10〜 |

| 走順(run) | 重み |
|-----------|------|
| 1（直近） | 1.0 |
| 2 | 0.8 |
| 3 | 0.6 |
| 4 | 0.4 |
| 5 | 0.2 |

### 4.2 Last3F Score（上がり3F / 配分 25%）

上がり3Fの加重平均を 33秒=100点 〜 42秒=0点 のスケールに変換。

### 4.3 Upset Score（穴馬力 / 配分 20%）

各過去走で「人気順位 > 着順」（人気以上の好走）だった差分の平均を集計。
平均差 3 以上で 100 点。

### 4.4 Venue Score（コース適性 / 配分 15%）

今回と同じ開催場所での過去走着順ポイント平均 + 実績件数ボーナス。
同コース実績がなければ、経験数に応じた基礎点。

### 4.5 Total Score（合計）

```
Total = Form×0.40 + Last3F×0.25 + Upset×0.20 + Venue×0.15
```

---

## 5. Gap・評価ランクの定義

### Gap（ギャップ）

```
Gap = 人気順位（market rank） − 能力順位（ability rank）
```

| Gap | 意味 |
|-----|------|
| 正の大きい値 | 市場が大きく過小評価 → バリュー大 |
| 0 付近 | 市場評価と能力が一致 |
| 負の大きい値 | 市場が過大評価 → 人気先行 |

### 評価ランク

| ランク | 条件 | 意味 |
|--------|------|------|
| **S** ★ | Gap ≥ 4 かつ スコア ≥ フィールド平均 | 大バリュー。市場が大幅に過小評価しており能力も高い |
| **A** ◎ | Gap ≥ 2 かつ スコア ≥ フィールド平均×0.8 | バリューあり。市場評価より実力が上 |
| **B** ○ | Gap ≥ 0 | 適正〜やや妙味あり |
| **C** △ | Gap < 0 | 人気先行。市場評価が能力を上回っている |

---

## 6. 出力

### 6.1 コンソール出力

- **評価一覧テーブル**: 全馬を評価順（S→A→B→C）で表示。馬番・馬名・騎手・オッズ・人気・スコア・能力順位・Gap・評価ランク。
- **スコア内訳**: 能力順に、Form / 3F / 穴力 / 適性 / 合計 / 過去走数を表示。
- **バリュー注目馬サマリー**: S 評価・A 評価の馬を強調表示。

### 6.2 JSON出力

`output/value_hunter_result.json` に保存。

```json
{
  "race_id": "...",
  "race_name": "...",
  "venue": "...",
  "race_date": "...",
  "course_type": "...",
  "distance": ...,
  "field_average_score": ...,
  "evaluations": [
    {
      "number": ...,
      "horse_name": "...",
      "jockey": "...",
      "odds": ...,
      "popularity": ...,
      "form_score": ...,
      "last3f_score": ...,
      "upset_score": ...,
      "venue_score": ...,
      "total_score": ...,
      "ability_rank": ...,
      "gap": ...,
      "evaluation": "S/A/B/C",
      "past_race_count": ...
    }
  ]
}
```

---

## 7. 実行方法

```bash
# デフォルト（input: output/result.json → output: output/value_hunter_result.json）
python value_hunter.py

# 入力・出力を指定
python value_hunter.py -i output/result.json -o output/vh_result.json

# JSON出力のみ（コンソール表示なし）
python value_hunter.py --json-only
```

---

## 8. 成果物一覧

| ファイル | 役割 |
|----------|------|
| **`output/result.json`** | 入力（唯一のインプット） |
| **`value_hunter.py`** | 本ツール本体（スコア算出・Gap・評価ランク・CLI・出力） |
| **`output/value_hunter_result.json`** | 評価結果JSON（出力） |
| **`docs/00_作業全体像.md`** | 本ドキュメント |

---

## 9. まとめ

- **入力は `output/result.json` のみ。**
- 4つのスコア（Form / Last3F / Upset / Venue）を算出し、合計スコアで能力順位を付ける。
- 能力順位と人気順位の差（Gap）から、市場に過小評価されている馬（バリュー）を S/A/B/C でランク付けする。
- Gap が大きく正でスコアも高い馬が「買い」の候補となる。
