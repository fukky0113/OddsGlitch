# netkeiba「競馬新聞」データ抽出エンジン — 作業全体像

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| **目的** | netkeiba の「競馬新聞」ページ（`newspaper.html`）から、レース基本情報および出走馬の過去5走成績を抽出し、規定のJSON形式で出力するPythonスクリプトを実装する |
| **入力** | 競馬新聞ページのURL（例: `?race_id=202608020411&rf=shutuba_submenu`）またはHTMLソース |
| **出力** | 設計書で定義されたスキーマに準拠したJSON |
| **スコープ外** | AI展開予想・ラップ予測・厩舎コメント・調教タイムおよびJS実行が必要な動的コンテンツ |

---

## 2. 作業フェーズと成果物

```
Phase 0: 準備・環境
    ↓
Phase 1: HTML取得・パーサ基盤
    ↓
Phase 2: レース基本情報抽出
    ↓
Phase 3: 出走馬・過去5走抽出
    ↓
Phase 4: JSON出力・欠損値・正規化
    ↓
Phase 5: CLI・運用・テスト
```

### Phase 0: 準備・環境

| # | タスク | 成果物 |
|---|--------|--------|
| 0.1 | プロジェクト構成・仮想環境 | `pyproject.toml` / `requirements.txt`, `venv` |
| 0.2 | 設計書のスキーマを型定義化 | `schemas/` または Pydantic/dataclass 定義 |
| 0.3 | 設定（URLベース・インターバル等） | `config.py` または `.env` |

### Phase 1: HTML取得・パーサ基盤

| # | タスク | 成果物 |
|---|--------|--------|
| 1.1 | ページ取得（requests または Selenium） | `fetcher.py` |
| 1.2 | テーブル出現待機（WebDriverWait） | `fetcher.py` 内 |
| 1.3 | BeautifulSoup で指定クラスにスコープしたツリー取得 | `parser/base.py` 等 |
| 1.4 | 共通前処理（HTMLエンティティ・全角空白除去） | `parser/utils.py` |

### Phase 2: レース基本情報抽出

| # | タスク | 成果物 |
|---|--------|--------|
| 2.1 | `RaceList_NameBox` 配下の取得 | `parser/race_info.py` |
| 2.2 | `RaceList_Item_Data1` の Raw テキスト取得 → `race_info_text` | 同上 |
| 2.3 | 正規表現による各項目抽出（発走時刻・芝/ダ・距離・馬場・天候・日付・場所） | 同上 |
| 2.4 | `race_date` の標準形式変換（YYYY/MM/DD） | 同上 |
| 2.5 | `race_id` をURLクエリから取得 | 同上 or `fetcher` |

### Phase 3: 出走馬・過去5走抽出

| # | タスク | 成果物 |
|---|--------|--------|
| 3.1 | `Shutuba_Table.Shutuba_Past5_Table` の `tr` ループ | `parser/horses.py` |
| 3.2 | 馬番・馬名リンク（horse_id 10桁）・馬名・騎手・斤量の抽出 | 同上 |
| 3.3 | 過去5走セルを順に解析（date, venue, position, time, last_3f） | 同上 |
| 3.4 | 5戦未満の馬の欠損（スキップ or null）方針の実装 | 同上 |

### Phase 4: JSON出力・欠損値・正規化

| # | タスク | 成果物 |
|---|--------|--------|
| 4.1 | `race_info.lap_prediction` / `development` を空オブジェクトで出力 | `builder.py` または `serializer.py` |
| 4.2 | `poplar` を空配列で出力 | 同上 |
| 4.3 | 設計書サンプルに準拠したJSON生成 | 同上 |
| 4.4 | 不正・欠損データ時のフォールバック（例外・ログ） | エラーハンドリング |

### Phase 5: CLI・運用・テスト

| # | タスク | 成果物 |
|---|--------|--------|
| 5.1 | コマンドライン引数（URL or race_id）で実行 | `main.py` / `cli.py` |
| 5.2 | リクエスト間インターバル設定と適用 | `fetcher.py` |
| 5.3 | 単体テスト（パーサ・正規表現・日付変換） | `tests/` |
| 5.4 | 結合テスト（モックHTML or 実URL 1レース） | `tests/` |
| 5.5 | README・実行手順・注意事項 | `README.md` |

---

## 3. 成果物一覧（ファイル想定）

```
OddsGlitch/
├── README.md
├── pyproject.toml または requirements.txt
├── config.py / .env.example
├── main.py              # エントリポイント
├── fetcher.py           # HTML取得・待機
├── parser/
│   ├── __init__.py
│   ├── base.py          # スコープ付きDOM取得
│   ├── utils.py         # テキスト正規化・共通処理
│   ├── race_info.py     # RaceList_NameBox 解析
│   └── horses.py        # Shutuba_Past5_Table 解析
├── builder.py           # または serializer.py（JSON組み立て）
├── schemas.py           # 出力型（Pydantic/dataclass）
├── tests/
│   ├── test_race_info.py
│   ├── test_horses.py
│   ├── test_builder.py
│   └── fixtures/        # サンプルHTML断片
└── docs/
    ├── 00_作業全体像.md  # 本ドキュメント
    └── 01_詳細設計・実装要件.md  # 既存設計書を格納
```

---

## 4. 技術スタック（案）

| 用途 | 候補 |
|------|------|
| HTML取得 | `requests` + 静的HTML または `selenium`（動的待機が必要な場合） |
| パース | `beautifulsoup4`（指定クラス内のみ解析） |
| 正規表現 | `re`（標準ライブラリ） |
| 型・バリデーション | `pydantic` または `dataclass` |
| CLI | `argparse` または `typer` |
| テスト | `pytest` |
| 環境 | Python 3.10+ |

---

## 5. 前提条件・リスク

| 種類 | 内容 |
|------|------|
| **前提** | 対象クラス（`RaceList_NameBox`, `Shutuba_Table Shutuba_Past5_Table`）がHTMLソースに含まれること。netkeibaのHTML構造変更でセレクタが変わるリスクあり。 |
| **運用** | 負荷軽減のためリクエスト間隔を設ける。利用規約・robots.txtの確認を推奨。 |
| **欠損** | 過去走5戦未満・馬場/天候未発表などは設計書の欠損値方針に従う。 |

---

## 6. マイルストーン（目安）

| マイルストーン | 完了条件 |
|----------------|----------|
| M1: 環境・スキーマ確定 | 仮想環境で依存関係インストール完了、出力JSONの型定義がコード化されている |
| M2: レース情報のみ抽出 | サンプルHTMLから `race` オブジェクトが設計書通りに出力される |
| M3: 出走馬・過去走まで抽出 | 同一HTMLから `horses` 配列（過去5走含む）が設計書通りに出力される |
| M4: 実URLでE2E動作 | `race_id` 指定で1レース分のJSONが取得・出力される |
| M5: テスト・ドキュメント整備 | 主要パーサの単体テストとREADMEが整い、運用上の注意が明文化されている |

---

## 7. 次のアクション

1. **設計書の正式配置** — 本設計書を `docs/01_詳細設計・実装要件.md` 等に保存し、スキーマ・セレクタを単一ソースとして参照する。
2. **Phase 0 着手** — プロジェクト構成・`requirements.txt`・スキーマ定義の作成。
3. **サンプルHTMLの確保** — 実ページのHTMLを1件保存し、パーサ開発・テストのfixtureとする（必要に応じて匿名化）。

以上が作業全体像である。実装は Phase 0 から順に進めることを推奨する。
